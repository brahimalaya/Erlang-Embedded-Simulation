#!/bin/bash

# Read config file
CONFIG="embar.config"
. $CONFIG

case "$1" in
    rconsole)

        # Script vars
        APP_DIR=${PWD##*/}
        GZ="$APP_DIR.tar.gz"

        # Ensure this script is running as the appropriate user
        RUNNER_USER=
        if [ ! -z "$RUNNER_USER" ] && [ `whoami` != "$RUNNER_USER" ]; then
            exec sudo -u $RUNNER_USER -i $0 $@
        fi

        # Get network interface
        INTERFACE=$(ifconfig | grep -E1 $EHA | grep -Eo 'en[0-9]*')

        # Set ip for gateway for beagbleboard
        # Need to do this as sudo
        echo "Set $INTERFACE to $GATEWAY_IP"
        sudo ifconfig $INTERFACE $GATEWAY_IP

        # Remove log files etc. before compress?

        # Go outside app dir, tar application dir, go back
        # This is so we don't get path contains .. on untaring
        echo "Tar $APP_DIR"
        cd ../
        tar zcf "$APP_DIR/$GZ" $APP_DIR
        cd $APP_DIR

        # Send compressed app over scp
        echo "Upload to $SSH_USER@$SSH_IP:$GZ"
        scp $GZ "$SSH_USER@$SSH_IP:$GZ"

        # Start ssh, untar file, cd to app dir, boot
        echo "Login to $SSH_USER@$SSH_IP"
        echo "Untar $GZ"
        echo "Boot $APP_DIR with $BOOT_CMD"
        SSH_CMD="tar zxf $GZ && cd $APP_DIR && $BOOT_CMD"
        ssh -t "$SSH_USER@$SSH_IP" $SSH_CMD
        ;;
    *)
        SCRIPT=$(basename $0)
        echo "Usage: $SCRIPT {rconsole}"
        ;;
esac

exit 0